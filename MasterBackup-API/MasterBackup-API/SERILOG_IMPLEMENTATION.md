# ‚úÖ Implementaci√≥n de Serilog - COMPLETADA

## Resumen

Se ha implementado exitosamente Serilog para el registro de logs con las siguientes caracter√≠sticas:

- **Registro en Base de Datos PostgreSQL** con retenci√≥n de 5 d√≠as
- **Fallback a Archivos** cuando la base de datos no est√° disponible
- **Ruta configurable** a trav√©s de appsettings.json
- **Limpieza autom√°tica** de logs antiguos mediante Background Service

## üì¶ Paquetes NuGet Instalados

- **Serilog.AspNetCore** 9.0.0
- **Serilog.Sinks.PostgreSQL** 2.3.0
- **Serilog.Sinks.File** 7.0.0
- **Serilog.Settings.Configuration** 10.0.0
- **Serilog.Enrichers.Environment** 3.0.1
- **Serilog.Enrichers.Thread** 4.0.0

## üóÉÔ∏è Estructura de Base de Datos

### Tabla: Logs

La tabla se crea autom√°ticamente a trav√©s de Entity Framework Migrations:

```sql
CREATE TABLE "Logs" (
    "Id" integer PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    "Message" text NOT NULL,
    "Level" character varying(50) NOT NULL,
    "TimeStamp" timestamp with time zone NOT NULL,
    "Exception" text NULL,
    "Properties" text NULL,
    "LogEvent" text NULL
);

CREATE INDEX "IX_Logs_TimeStamp" ON "Logs" ("TimeStamp");
```

### Migraci√≥n

Archivo: `Infrastructure/Persistence/Migrations/Master/20251127023936_AddLogsTable.cs`

Para aplicar la migraci√≥n:
```bash
dotnet ef database update --context MasterDbContext
```

## ‚öôÔ∏è Configuraci√≥n

### appsettings.json

```json
{
  "Serilog": {
    "MinimumLevel": {
      "Default": "Information",
      "Override": {
        "Microsoft": "Warning",
        "Microsoft.AspNetCore": "Warning",
        "Microsoft.EntityFrameworkCore": "Warning",
        "System": "Warning"
      }
    },
    "WriteTo": [
      {
        "Name": "PostgreSQL",
        "Args": {
          "connectionString": "Host=localhost;Port=5432;Database=master_saas;Username=postgres;Password=admin",
          "tableName": "Logs",
          "needAutoCreateTable": false,
          "restrictedToMinimumLevel": "Information"
        }
      },
      {
        "Name": "File",
        "Args": {
          "path": "Logs/log-.txt",
          "rollingInterval": "Day",
          "retainedFileCountLimit": 7,
          "restrictedToMinimumLevel": "Warning"
        }
      },
      {
        "Name": "Console",
        "Args": {
          "restrictedToMinimumLevel": "Information"
        }
      }
    ],
    "Enrich": [ "FromLogContext", "WithMachineName", "WithThreadId" ]
  }
}
```

### Configuraci√≥n Personalizable

Puedes cambiar la ruta de los archivos de log editando:
```json
"path": "Logs/log-.txt"
```

Por ejemplo:
- `"path": "C:/MyLogs/app-.log"` - Ruta absoluta
- `"path": "logs/app-.txt"` - Ruta relativa
- `"path": "../SharedLogs/api-.log"` - Ruta relativa al directorio padre

## üîÑ Sistema de Fallback

Serilog est√° configurado con un sistema de fallback inteligente:

1. **Intenta escribir en PostgreSQL**
   - Si la base de datos est√° disponible, escribe todos los logs de nivel `Information` o superior

2. **Fallback autom√°tico a archivos**
   - Si la base de datos no est√° disponible, escribe autom√°ticamente en archivos
   - Los archivos rotan diariamente (`RollingInterval.Day`)
   - Se mantienen los √∫ltimos 7 d√≠as de archivos

3. **Consola siempre activa**
   - Los logs siempre se muestran en consola para debugging

## üßπ Limpieza Autom√°tica de Logs

### LogCleanupService

Archivo: `Infrastructure/Services/LogCleanupService.cs`

- **Frecuencia**: Se ejecuta cada 24 horas
- **Retenci√≥n**: Elimina logs con m√°s de 5 d√≠as de antig√ºedad
- **Autom√°tico**: Se inicia al arrancar la aplicaci√≥n

```csharp
private readonly TimeSpan _cleanupInterval = TimeSpan.FromHours(24);
private readonly int _retentionDays = 5;
```

### Personalizaci√≥n

Para cambiar la retenci√≥n, edita las constantes en `LogCleanupService.cs`:

```csharp
// Cambiar retenci√≥n a 7 d√≠as
private readonly int _retentionDays = 7;

// Cambiar frecuencia de limpieza a cada 12 horas
private readonly TimeSpan _cleanupInterval = TimeSpan.FromHours(12);
```

## üìù Uso en C√≥digo

### Inyecci√≥n de Dependencias

Serilog se integra autom√°ticamente con el sistema de logging de .NET:

```csharp
public class MyService
{
    private readonly ILogger<MyService> _logger;

    public MyService(ILogger<MyService> logger)
    {
        _logger = logger;
    }

    public void MyMethod()
    {
        _logger.LogInformation("Informaci√≥n general");
        _logger.LogWarning("Advertencia");
        _logger.LogError("Error");
        _logger.LogCritical("Error cr√≠tico");
    }
}
```

### Logs Estructurados

```csharp
_logger.LogInformation("Usuario {UserId} inici√≥ sesi√≥n desde {IpAddress}",
    userId, ipAddress);
```

### Contexto Enriquecido

Los logs incluyen autom√°ticamente:
- **MachineName**: Nombre de la m√°quina
- **ThreadId**: ID del hilo de ejecuci√≥n
- **LogContext**: Contexto personalizado

## üéØ Niveles de Log

| Nivel | Base de Datos | Archivos | Consola |
|-------|---------------|----------|---------|
| Verbose | ‚ùå | ‚ùå | ‚ùå |
| Debug | ‚ùå | ‚ùå | ‚ùå |
| Information | ‚úÖ | ‚ùå | ‚úÖ |
| Warning | ‚úÖ | ‚úÖ | ‚úÖ |
| Error | ‚úÖ | ‚úÖ | ‚úÖ |
| Fatal | ‚úÖ | ‚úÖ | ‚úÖ |

## üîç Consultas √ötiles

### Ver logs recientes
```sql
SELECT * FROM "Logs"
ORDER BY "TimeStamp" DESC
LIMIT 100;
```

### Ver logs de error
```sql
SELECT * FROM "Logs"
WHERE "Level" IN ('Error', 'Fatal')
ORDER BY "TimeStamp" DESC;
```

### Ver logs de hoy
```sql
SELECT * FROM "Logs"
WHERE "TimeStamp" >= CURRENT_DATE
ORDER BY "TimeStamp" DESC;
```

### Contar logs por nivel
```sql
SELECT "Level", COUNT(*) as "Count"
FROM "Logs"
GROUP BY "Level"
ORDER BY "Count" DESC;
```

## ‚úÖ Ventajas de esta Implementaci√≥n

1. **Alta Disponibilidad**: Fallback autom√°tico a archivos si la BD falla
2. **Performance**: Logs as√≠ncronos no bloquean la aplicaci√≥n
3. **Mantenimiento**: Limpieza autom√°tica cada 24 horas
4. **Flexibilidad**: Configuraci√≥n por appsettings.json
5. **Debugging**: Consola siempre activa en desarrollo
6. **Logs Estructurados**: Facilita b√∫squedas y an√°lisis
7. **Retenci√≥n Controlada**: Solo 5 d√≠as en BD para optimizar espacio

## üöÄ Pr√≥ximos Pasos Opcionales

1. **Integraci√≥n con servicios externos**:
   - Seq (https://datalust.co/seq)
   - Elasticsearch
   - Application Insights

2. **Alertas**:
   - Configurar alertas para errores cr√≠ticos
   - Enviar emails cuando hay errores fatales

3. **Dashboard**:
   - Crear dashboard para visualizar logs
   - Gr√°ficas de errores por tiempo

## üìö Documentaci√≥n

- [Serilog](https://serilog.net/)
- [Serilog.Sinks.PostgreSQL](https://github.com/b00ted/serilog-sinks-postgresql)
- [Serilog.Sinks.File](https://github.com/serilog/serilog-sinks-file)
